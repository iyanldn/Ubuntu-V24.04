name: 🐧 Ubuntu 24.04 Rootfs Builder (Hybrid Auto Snapshot + Termux Ready)

on:
  workflow_dispatch:
  push:
    branches: [main, master]
    paths:
      - '.github/workflows/ubuntu24-auto-rootfs.yml'

permissions:
  contents: write

jobs:
  build-ubuntu-rootfs:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🔽 Download Ubuntu 24.04 Rootfs (Try LXC → fallback Andronix)
        run: |
          mkdir -p ubuntu24-rootfs
          cd ubuntu24-rootfs

          echo "📦 Trying to download from LXC mirror..."
          LXC_URL="https://images.linuxcontainers.org/images/ubuntu/noble/arm64/default/latest/rootfs.tar.xz"
          FALLBACK_URL="https://raw.githubusercontent.com/AndronixApp/AndronixOrigin/main/Rootfs/Ubuntu24.tar.xz"

          if wget -v --tries=2 "$LXC_URL" -O rootfs.tar.xz; then
            echo "✅ Downloaded from LXC mirror!"
          else
            echo "⚠️ LXC mirror failed! Trying fallback from Andronix..."
            wget -v "$FALLBACK_URL" -O rootfs.tar.xz || (echo "❌ Both sources failed! Exiting."; exit 1)
          fi

          echo "📂 Extracting rootfs..."
          if ! tar -xJf rootfs.tar.xz; then
            echo "❌ Extraction failed!"
            ls -lh
            exit 1
          fi

          rm rootfs.tar.xz
          echo "✅ Ubuntu 24.04 Rootfs extracted successfully!"

      - name: ⚙️ Generate Termux Launcher Script
        run: |
          echo "🛠️ Generating Termux launcher script..."
          cat > start-ubuntu.sh << 'EOF'
          #!/data/data/com.termux/files/usr/bin/bash
          cd $(dirname $0)
          proot --link2symlink -0 \
            -r ubuntu24-rootfs \
            -b /dev -b /proc -b /sys \
            -b /data/data/com.termux/files/home:/root \
            -w /root /usr/bin/env -i \
            HOME=/root TERM=$TERM LANG=C.UTF-8 PATH=/usr/local/sbin:/usr/local/bin:/bin:/usr/bin:/sbin:/usr/sbin \
            /bin/bash --login
          EOF
          chmod +x start-ubuntu.sh
          echo "✅ start-ubuntu.sh generated!"

      - name: 🗜️ Compress Rootfs (XZ)
        run: |
          mkdir -p release-output
          echo "📦 Compressing rootfs (this may take a few minutes)..."
          tar -cf - ubuntu24-rootfs | xz -9 -T0 > release-output/ubuntu24-noble-arm64-rootfs.tar.xz
          cp start-ubuntu.sh release-output/
          sha256sum release-output/* > release-output/SHA256SUMS.txt
          echo "✅ Compression & checksum complete."

      - name: ☁️ Upload ke GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v24.04-lts-${{ github.run_number }}
          name: Ubuntu 24.04 LTS Rootfs (Hybrid Build #${{ github.run_number }})
          files: |
            release-output/ubuntu24-noble-arm64-rootfs.tar.xz
            release-output/start-ubuntu.sh
            release-output/SHA256SUMS.txt
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📤 Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu24-rootfs-output
          path: release-output/

      - name: ✅ Done
        run: |
          echo "🎉 Ubuntu 24.04 LTS Rootfs + Termux Launcher built successfully!"
          echo "🔗 Check release here: https://github.com/${{ github.repository }}/releases"
