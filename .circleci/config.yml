version: 2.1

jobs:
  ubuntu24-full-dev:
    docker:
      - image: ubuntu:24.04
    environment:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - checkout

      - run:
          name: üîÅ Ganti Mirror APT (Fix 403 Forbidden)
          command: |
            sed -i 's|http://archive.ubuntu.com/ubuntu|http://mirror.kku.ac.th/ubuntu|g' /etc/apt/sources.list
            sed -i 's|http://security.ubuntu.com/ubuntu|http://mirror.kku.ac.th/ubuntu|g' /etc/apt/sources.list
            apt-get update || true

      - run:
          name: ‚ú® Set Metadata & Env
          command: |
            DATE=$(date +%Y-%m-%d)
            echo "export TAR_NAME=ubuntu24-full-dev-$DATE.tar.gz" >> $BASH_ENV
            echo "export RELEASE_NAME='Ubuntu 24.04 Full Dev Snapshot - $DATE'" >> $BASH_ENV
            echo "export TAG_NAME=v24.04-full-$DATE" >> $BASH_ENV
            echo "üìÜ Snapshot Date: $DATE"

      - run:
          name: üåç Set Timezone Asia/Makassar
          command: |
            echo "Asia/Makassar" > /etc/timezone
            ln -sf /usr/share/zoneinfo/Asia/Makassar /etc/localtime
            dpkg-reconfigure -f noninteractive tzdata || true
            date

      - run:
          name: üîÑ Update dan Upgrade
          command: |
            apt-get update && apt-get upgrade -y

      - run:
          name: üß∞ Install CLI Tools
          command: |
            apt-get install -y \
              git curl wget unzip zip build-essential \
              make cmake gcc g++ zsh jq htop tree \
              net-tools file gnupg tzdata neovim tmux \
              sudo software-properties-common openssh-client

      - run:
          name: üìö Install Python + Java + Go + Ruby
          command: |
            apt-get install -y \
              python3 python3-pip python3-venv \
              golang-go openjdk-21-jdk ruby-full default-jdk \
              --fix-missing

      - run:
          name: üåê Install Node.js via NodeSource
          command: |
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
            apt-get install -y nodejs

      - run:
          name: üåê Install Web Stack
          command: |
            apt-get install -y \
              nginx mariadb-server redis-server \
              postgresql php php-cli php-fpm \
              sqlite3 --fix-missing
            echo "‚úÖ Web stack terinstall tanpa error"

      - run:
          name: üê≥ Install Docker + Compose
          command: |
            apt-get install -y ca-certificates curl gnupg lsb-release
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | \
              gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt-get update
            apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

      - run:
          name: üîê Install Security Tools
          command: |
            apt-get install -y ufw fail2ban nmap sslscan lynis whois

      - run:
          name: ü§ñ Install Python AI/ML
          command: |
            pip3 install --break-system-packages \
              numpy pandas matplotlib scikit-learn \
              jupyter seaborn opencv-python \
              transformers torch torchvision

      - run:
          name: üßæ Setup Configs + Dummy File
          command: |
            mkdir -p ~/.config/nvim ~/.config/tmux ~/dummy
            echo "set number" > ~/.config/nvim/init.vim
            echo "set -g mouse on" > ~/.config/tmux/tmux.conf
            echo "alias ll='ls -la'" > ~/.zshrc
            dd if=/dev/zero of=~/dummy/filler.bin bs=1M count=800 || true

      - run:
          name: üì¶ Compress Snapshot
          command: |
            mkdir -p full-dev-snapshot
            cp -r ~/.config full-dev-snapshot/config || true
            cp ~/.zshrc full-dev-snapshot/zshrc || true
            cp -r ~/dummy full-dev-snapshot/dummy || true
            echo "$RELEASE_NAME" > full-dev-snapshot/README.txt
            tar -czf "$TAR_NAME" full-dev-snapshot

      - run:
          name: üìè Check File Size
          command: |
            ls -lh "$TAR_NAME"
            du -h "$TAR_NAME"

      - store_artifacts:
          path: ubuntu24-full-dev-*.tar.gz
          destination: full-dev-snapshot

workflows:
  version: 2
  full_build:
    jobs:
      - ubuntu24-full-dev
